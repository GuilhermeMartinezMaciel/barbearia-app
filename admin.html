<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Barbearia</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --gold: #d4af37;
            --text: #e0e0e0;
            --danger: #ff4d4d;
            --success: #25D366; /* Cor do Zap */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        h1 { color: var(--gold); margin: 0; font-size: 1.5rem; text-transform: uppercase; }

        /* CARDS DE RESUMO (KPIs) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .stat-title { color: #888; font-size: 0.9rem; text-transform: uppercase; }
        .stat-value { font-size: 2rem; font-weight: bold; color: white; margin-top: 5px; }

        /* FILTROS */
        .filter-bar {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-bar input {
            background: #2c2c2c;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
        }

        .btn-filter {
            background: var(--gold);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-filter.secondary { background: #444; color: white; }

        /* TABELA */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #252525; color: var(--gold); font-weight: 600; }
        tr:hover { background-color: #2c2c2c; }

        /* BOT√ïES DE A√á√ÉO */
        .actions { display: flex; gap: 10px; }

        .btn-icon {
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
        }

        .btn-zap { background: rgba(37, 211, 102, 0.1); color: var(--success); }
        .btn-zap:hover { background: var(--success); color: white; }

        .btn-trash { background: rgba(255, 77, 77, 0.1); color: var(--danger); }
        .btn-trash:hover { background: var(--danger); color: white; }

        .tag-servico {
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header>
            <h1>Painel do Barbeiro</h1>
            <button class="btn-filter secondary" onclick="carregarAgendamentos()">üîÑ Atualizar</button>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Agendamentos</div>
                <div class="stat-value" id="total-agendamentos">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Faturamento Estimado</div>
                <div class="stat-value" id="total-faturamento">R$ 0,00</div>
            </div>
        </div>

        <div class="filter-bar">
            <label>üìÖ Filtrar data:</label>
            <input type="date" id="filtro-data" onchange="aplicarFiltro()">
            <button class="btn-filter secondary" onclick="limparFiltro()">Ver Todos</button>
        </div>

        <table id="tabela-agendamentos">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Servi√ßo</th>
                    <th>WhatsApp</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // Tabela de pre√ßos para calcular faturamento (Tem que bater com o index.html)
        const precos = {
            "Corte": 40,
            "Barba": 30,
            "Completo": 65,
            "Pezinho": 15
        };

        let todosAgendamentos = []; // Guarda os dados brutos

        async function carregarAgendamentos() {
            const tabela = document.querySelector('#tabela-agendamentos tbody');
            tabela.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Carregando...</td></tr>';

            try {
                const resposta = await fetch('http://localhost:3000/agendamentos');
                todosAgendamentos = await resposta.json();
                
                // Ordenar por Data e Hora
                todosAgendamentos.sort((a, b) => {
                    const dataA = new Date(`${a.data}T${a.hora}`);
                    const dataB = new Date(`${b.data}T${b.hora}`);
                    return dataA - dataB;
                });

                // Se tiver data selecionada no filtro, usa ela. Se n√£o, mostra tudo.
                aplicarFiltro();

            } catch (erro) {
                console.error(erro);
                alert("Erro ao conectar com o servidor.");
            }
        }

        function aplicarFiltro() {
            const dataFiltro = document.getElementById('filtro-data').value;
            
            let listaFiltrada = todosAgendamentos;

            // Se tiver data no input, filtra
            if (dataFiltro) {
                listaFiltrada = todosAgendamentos.filter(item => item.data === dataFiltro);
            }

            renderizarTabela(listaFiltrada);
            atualizarKPIs(listaFiltrada);
        }

        function limparFiltro() {
            document.getElementById('filtro-data').value = '';
            aplicarFiltro();
        }

        function renderizarTabela(lista) {
            const tabela = document.querySelector('#tabela-agendamentos tbody');
            tabela.innerHTML = '';

            if (lista.length === 0) {
                tabela.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#777;">Nenhum agendamento encontrado.</td></tr>';
                return;
            }

            lista.forEach(cliente => {
                // Limpa o n√∫mero do whats para criar o link (tira parenteses e tra√ßos)
                const zapLimpo = cliente.whatsapp.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero
                
                const linha = `
                    <tr>
                        <td style="color:white; font-weight:bold;">${cliente.hora} <br> <small style="color:#777; font-weight:normal">${formatarData(cliente.data)}</small></td>
                        <td>${cliente.nome}</td>
                        <td><span class="tag-servico">${cliente.servico}</span></td>
                        <td>${cliente.whatsapp}</td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon btn-zap" onclick="window.open('https://wa.me/55${zapLimpo}', '_blank')" title="Abrir WhatsApp">
                                    üí¨
                                </button>
                                <button class="btn-icon btn-trash" onclick="deletar(${cliente.id})" title="Cancelar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tabela.innerHTML += linha;
            });
        }

        function atualizarKPIs(lista) {
            // Conta quantos
            document.getElementById('total-agendamentos').textContent = lista.length;

            // Soma o dinheiro
            let faturamento = 0;
            lista.forEach(item => {
                // Pega o pre√ßo da lista de pre√ßos, se n√£o achar usa 0
                faturamento += precos[item.servico] || 0;
            });

            document.getElementById('total-faturamento').textContent = faturamento.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        async function deletar(id) {
            if (!confirm("Tem certeza que deseja excluir este agendamento?")) return;

            try {
                await fetch(`http://localhost:3000/agendamento/${id}`, { method: 'DELETE' });
                carregarAgendamentos(); // Recarrega tudo
            } catch (erro) {
                alert("Erro ao deletar.");
            }
        }

        function formatarData(dataAmericana) {
            const partes = dataAmericana.split('-');
            return `${partes[2]}/${partes[1]}`;
        }

        // Define a data de hoje no filtro automaticamente ao abrir
        window.onload = () => {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('filtro-data').value = hoje;
            carregarAgendamentos();
        };

    </script>
</body>
</html>